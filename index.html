<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoiceNote - Multi-language Speech to Text</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 1rem 0;
      background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
      color: #333;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .container {
      background-color: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      width: min(90vw, 800px);
      min-height: auto;
      height: auto;
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .header i {
      font-size: 3rem;
      color: #0984e3;
      margin-bottom: 0.5rem;
    }
    h1 {
      text-align: center;
      color: #4a4a4a;
      margin-bottom: 0.5rem;
      font-size: 2.5rem;
      font-weight: 300;
    }
    .subtitle {
      text-align: center;
      color: #888;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      font-weight: 300;
    }
    .voice-icons {
      text-align: center;
      margin-bottom: 1rem;
    }
    .voice-icons i {
      display: none;
    }
    .voice-image {
      display: block;
      margin: 0 auto 1rem auto;
      max-width: 150px;
      opacity: 0.8;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }
    label {
      font-weight: bold;
      margin-right: 0.5rem;
    }
    select {
      font-size: 1rem;
      padding: 0.75rem;
      margin: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }
    select:hover {
      border-color: #0984e3;
    }
    button {
      font-size: 1rem;
      padding: 0.75rem 1.5rem;
      margin: 0.5rem;
      border: none;
      border-radius: 5px;
      background-color: #0984e3;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      font-weight: bold;
    }
    button:hover {
      background-color: #0652dd;
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    #transcript {
      width: 100%;
      height: 350px;
      flex-grow: 1;
      font-size: 1.1rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: none;
      background-color: #fafafa;
      line-height: 1.5;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: border-color 0.3s ease;
      overflow-y: auto;
    }
    #transcript:focus {
      outline: none;
      border-color: #0984e3;
    }
    #status {
      text-align: center;
      margin-top: 1.5rem;
      font-style: italic;
      color: #888;
      font-size: 1rem;
    }
    footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #aaa;
      border-top: 1px solid #eee;
      padding-top: 1rem;
    }
    @media (max-width: 768px) {
      body {
        display: block;
        overflow-y: auto;
        padding: 1rem;
      }
      .container {
        width: 100%;
        padding: 1rem;
        margin: 0;
        min-height: auto;
        height: auto;
        box-shadow: none;
      }
      h1 {
        font-size: 2rem;
      }
      #controls {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
      }
      select, button {
        width: 100%;
        max-width: 300px;
        margin: 0.25rem auto;
      }
      #transcript {
        height: 35vh;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>VoiceNote</h1>
      <p class="subtitle">Optimized for Telugu and Tamil Speech to Text</p>
      <div class="voice-icons"></div>
    </div>
    <div id="controls">
      <label for="language"><i class="fas fa-globe"></i> Select Language: </label>
      <select id="language"></select>
      <label for="translateLanguage"><i class="fas fa-language"></i> Translate to: </label>
      <select id="translateLanguage"></select>
      <label for="noiseReduction" style="display: none;"><input type="checkbox" id="noiseReduction"> Enable Noise Reduction</label>
      <label for="audioFile" style="display: none;"><i class="fas fa-upload"></i> Upload Audio File: <input type="file" id="audioFile" accept="audio/*"></label>

      <button id="startBtn"><i class="fas fa-play"></i> Start</button>
      <button id="stopBtn" disabled><i class="fas fa-stop"></i> Stop</button>
      <button id="translateBtn"><i class="fas fa-exchange-alt"></i> Translate</button>
      <button id="saveBtn"><i class="fas fa-save"></i> Save Transcription</button>
      <button id="copyBtn"><i class="fas fa-copy"></i> Copy</button>
      <button id="clearBtn"><i class="fas fa-trash-alt"></i> Clear</button>
    </div>
    <textarea id="transcript" placeholder="Your speech will appear here..." readonly></textarea>
    <div id="status"></div>
    <footer>Powered by Web Speech API</footer>
  </div>

  <script>
    // Supported languages
    const languages = [
      { code: 'te-IN', name: 'Telugu (India)' },
      { code: 'ta-IN', name: 'Tamil (India)' },
      { code: 'en-US', name: 'English (United States)' },
      { code: 'en-GB', name: 'English (United Kingdom)' },
      { code: 'es-ES', name: 'Spanish (Spain)' },
      { code: 'fr-FR', name: 'French (France)' },
      { code: 'de-DE', name: 'German (Germany)' },
      { code: 'it-IT', name: 'Italian (Italy)' },
      { code: 'ja-JP', name: 'Japanese (Japan)' },
      { code: 'zh-CN', name: 'Chinese (Mandarin, Simplified)' },
      { code: 'zh-TW', name: 'Chinese (Mandarin, Traditional)' },
      { code: 'ru-RU', name: 'Russian (Russia)' },
      { code: 'ar-SA', name: 'Arabic (Saudi Arabia)' },
      { code: 'hi-IN', name: 'Hindi (India)' },
      { code: 'bn-IN', name: 'Bengali (India)' },
      { code: 'mr-IN', name: 'Marathi (India)' },
      { code: 'ur-IN', name: 'Urdu (India)' },
      { code: 'gu-IN', name: 'Gujarati (India)' },
      { code: 'kn-IN', name: 'Kannada (India)' },
      { code: 'or-IN', name: 'Odia (India)' },
      { code: 'ml-IN', name: 'Malayalam (India)' },
      { code: 'pa-IN', name: 'Punjabi (India)' },
      { code: 'as-IN', name: 'Assamese (India)' },
      { code: 'mai-IN', name: 'Maithili (India)' },
      { code: 'pt-BR', name: 'Portuguese (Brazil)' },
      { code: 'ko-KR', name: 'Korean (South Korea)' },
      { code: 'nl-NL', name: 'Dutch (Netherlands)' },
      { code: 'sv-SE', name: 'Swedish (Sweden)' },
      { code: 'tr-TR', name: 'Turkish (Turkey)' },
      { code: 'pl-PL', name: 'Polish (Poland)' },
      { code: 'he-IL', name: 'Hebrew (Israel)' },
      { code: 'th-TH', name: 'Thai (Thailand)' },
      { code: 'vi-VN', name: 'Vietnamese (Vietnam)' },
      { code: 'fa-IR', name: 'Persian (Iran)' },
      { code: 'id-ID', name: 'Indonesian (Indonesia)' },
      { code: 'ms-MY', name: 'Malay (Malaysia)' },
      { code: 'ro-RO', name: 'Romanian (Romania)' },
      { code: 'hu-HU', name: 'Hungarian (Hungary)' },
      { code: 'el-GR', name: 'Greek (Greece)' },
      { code: 'cs-CZ', name: 'Czech (Czech Republic)' },
      { code: 'da-DK', name: 'Danish (Denmark)' },
      { code: 'fi-FI', name: 'Finnish (Finland)' },
      { code: 'no-NO', name: 'Norwegian (Norway)' }
    ];

    const languageSelect = document.getElementById('language');
    const translateLanguageSelect = document.getElementById('translateLanguage');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const translateBtn = document.getElementById('translateBtn');
    const transcriptArea = document.getElementById('transcript');
    const statusDiv = document.getElementById('status');
    const saveBtn = document.getElementById('saveBtn');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');

    // Populate dropdowns
    languages.forEach(lang => {
      const opt1 = document.createElement('option');
      opt1.value = lang.code;
      opt1.textContent = lang.name;
      languageSelect.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value = lang.code;
      opt2.textContent = lang.name;
      translateLanguageSelect.appendChild(opt2);
    });

    languageSelect.value = 'te-IN';
    translateLanguageSelect.value = 'en-US';

    // Cleanup function
    function cleanupAudio() {
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      if (filteredStream) {
        filteredStream.getTracks().forEach(track => track.stop());
        filteredStream = null;
      }
    }

    let recognition;
    let audioContext = null;
    let filteredStream = null;
    let accumulatedTranscript = '';

    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      statusDiv.textContent = 'Sorry, your browser does not support Speech Recognition.';
      startBtn.disabled = true;
      stopBtn.disabled = true;
      saveBtn.disabled = true;
    } else {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onstart = () => {
        statusDiv.textContent = 'Listening...';
        startBtn.disabled = true;
        stopBtn.disabled = false;
      };

      recognition.onerror = (event) => {
        statusDiv.textContent = 'Error: ' + event.error;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        cleanupAudio();
      };

      // ✅ NO AUTO-RESTART: recognition stops permanently on end
      recognition.onend = () => {
        statusDiv.textContent = 'Stopped listening.';
        startBtn.disabled = false;
        stopBtn.disabled = true;
        cleanupAudio();
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            accumulatedTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        transcriptArea.value = accumulatedTranscript + interimTranscript;
      };
    }

    // Start button
    startBtn.addEventListener('click', async () => {
      recognition.lang = languageSelect.value;
      accumulatedTranscript = '';
      transcriptArea.value = '';
      cleanupAudio();

      if (document.getElementById('noiseReduction').checked) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const source = audioContext.createMediaStreamSource(stream);

          const highPassFilter = audioContext.createBiquadFilter();
          highPassFilter.type = 'highpass';
          highPassFilter.frequency.value = 80;

          const lowPassFilter = audioContext.createBiquadFilter();
          lowPassFilter.type = 'lowpass';
          lowPassFilter.frequency.value = 3400;

          const compressor = audioContext.createDynamicsCompressor();
          compressor.threshold.value = -24;
          compressor.knee.value = 30;
          compressor.ratio.value = 12;
          compressor.attack.value = 0.003;
          compressor.release.value = 0.25;

          source.connect(highPassFilter);
          highPassFilter.connect(lowPassFilter);
          lowPassFilter.connect(compressor);

          const destination = audioContext.createMediaStreamDestination();
          compressor.connect(destination);
          filteredStream = destination.stream;

          if ('audioTrack' in recognition) {
            recognition.audioTrack = filteredStream.getAudioTracks()[0];
          } else {
            statusDiv.textContent = 'Noise reduction not fully supported; using default mic.';
          }
        } catch (error) {
          statusDiv.textContent = 'Mic error: ' + error.message;
          return;
        }
      }

      recognition.start();
    });

    // Stop button
    stopBtn.addEventListener('click', () => {
      if (recognition) {
        recognition.stop(); // Triggers onend
      }
    });

    // Save button
    saveBtn.addEventListener('click', () => {
      const text = transcriptArea.value.trim();
      if (!text) {
        alert('No transcription to save.');
        return;
      }
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'transcription.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Copy button
    copyBtn.addEventListener('click', () => {
      const text = transcriptArea.value.trim();
      if (!text) {
        alert('No transcription to copy.');
        return;
      }
      navigator.clipboard.writeText(text).then(() => {
        alert('Transcription copied to clipboard.');
      }).catch(() => {
        alert('Failed to copy. Please copy manually.');
      });
    });

    // Clear button
    clearBtn.addEventListener('click', () => {
      if (confirm('Clear the transcription?')) {
        transcriptArea.value = '';
      }
    });

    // Translation function
    async function translateText(text, sourceLang, targetLang) {
      const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        return data[0][0][0];
      } catch (error) {
        console.error('Translation error:', error);
        return null;
      }
    }

    // Translate button
    translateBtn.addEventListener('click', async () => {
      if (!navigator.onLine) {
        statusDiv.textContent = 'No internet. Translation requires connection.';
        return;
      }
      const text = transcriptArea.value.trim();
      if (!text) {
        alert('No text to translate.');
        return;
      }
      const sourceLang = languageSelect.value.split('-')[0];
      const targetLang = translateLanguageSelect.value.split('-')[0];

      if (sourceLang === targetLang) {
        statusDiv.textContent = 'Same language — no translation needed.';
        return;
      }

      statusDiv.textContent = 'Translating...';
      const translated = await translateText(text, sourceLang, targetLang);
      if (translated) {
        transcriptArea.value = translated;
        statusDiv.textContent = `Translated from ${sourceLang.toUpperCase()} to ${targetLang.toUpperCase()}.`;
      } else {
        statusDiv.textContent = 'Translation failed. Try again.';
      }
    });
  </script>

  <script>
    // Audio file upload (kept for completeness, though limited support)
    const audioFileInput = document.getElementById('audioFile');
    let audioElement = null;
    let fileAudioContext = null;
    let fileStream = null;

    function cleanupFileAudio() {
      if (audioElement) {
        audioElement.pause();
        audioElement.remove();
        audioElement = null;
      }
      if (fileAudioContext) {
        fileAudioContext.close();
        fileAudioContext = null;
      }
      if (fileStream) {
        fileStream.getTracks().forEach(track => track.stop());
        fileStream = null;
      }
    }

    audioFileInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      cleanupFileAudio();

      try {
        const arrayBuffer = await file.arrayBuffer();
        fileAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffer = await fileAudioContext.decodeAudioData(arrayBuffer);

        const source = fileAudioContext.createBufferSource();
        source.buffer = audioBuffer;
        const destination = fileAudioContext.createMediaStreamDestination();
        source.connect(destination);
        fileStream = destination.stream;

        const url = URL.createObjectURL(file);
        audioElement = new Audio(url);
        audioElement.controls = true;
        audioElement.style.display = 'block';
        audioElement.style.width = '100%';
        audioElement.style.margin = '1rem auto 0 auto';
        document.querySelector('.container').insertBefore(audioElement, transcriptArea);

        if ('audioTrack' in recognition) {
          recognition.audioTrack = fileStream.getAudioTracks()[0];
          statusDiv.textContent = 'Audio file loaded. Click Start to transcribe.';
        } else {
          statusDiv.textContent = 'File playback ready. Note: file transcription not supported in this browser.';
        }
      } catch (error) {
        statusDiv.textContent = 'Error loading audio: ' + error.message;
      }
    });
  </script>
</body>
</html>
